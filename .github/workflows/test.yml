name: ğŸ§ª Test GnFortress Docker Security Scanner

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      test-image:
        description: 'Docker image to test (default: nginx:latest)'
        required: false
        default: 'nginx:latest'

jobs:
  basic-test:
    name: "ğŸ” Basic Security Scan Test"
    runs-on: ubuntu-latest
    
    steps:
      - name: "ğŸ“¥ Checkout repository"
        uses: actions/checkout@v4
      
      - name: "ğŸ° Run GnFortress Docker Security Scanner"
        id: security-scan
        uses: ./
        with:
          image: 'nginx:latest'
          severity-threshold: 'MEDIUM'
          output-format: 'table'
          fail-on-critical: 'false'
      
      - name: "ğŸ“Š Display Scan Results"
        run: |
          echo "ğŸ† Scan completed successfully!"
          echo "ğŸ“ˆ Vulnerability Count: ${{ steps.security-scan.outputs.vulnerability-count }}"
          echo "ğŸ”´ Critical: ${{ steps.security-scan.outputs.critical-count }}"
          echo "ğŸŸ  High: ${{ steps.security-scan.outputs.high-count }}"
          echo "ğŸŸ¡ Medium: ${{ steps.security-scan.outputs.medium-count }}"
          echo "ğŸŸ¢ Low: ${{ steps.security-scan.outputs.low-count }}"
          echo "âœ… Status: ${{ steps.security-scan.outputs.scan-status }}"

  multi-image-test:
    name: "ğŸ”„ Multiple Images Test"
    runs-on: ubuntu-latest

    strategy:
      matrix:
        test-image: 
          - 'nginx:latest'
          - 'alpine:latest'
          - 'node:18'
        severity: ['HIGH', 'MEDIUM', 'LOW']
    
    steps:
      - name: "ğŸ“¥ Checkout repository"
        uses: actions/checkout@v4
      
      - name: "ğŸ” Scan ${{ matrix.test-image }} (Severity: ${{ matrix.severity }})"
        uses: ./
        with:
          image: ${{ matrix.test-image }}
          severity-threshold: ${{ matrix.severity }}
          output-format: 'json'

  performance-test:
    name: "âš¡ Performance Test"
    runs-on: ubuntu-latest
    
    steps:
      - name: "ğŸ“¥ Checkout repository"
        uses: actions/checkout@v4

      - name: "â±ï¸ Measure scan time"
        id: timer
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: "ğŸš€ Quick scan test"
        uses: ./
        with:
          image: 'alpine:latest'
          severity-threshold: 'HIGH'
          cache-enabled: 'true'

      - name: "ğŸ“Š Calculate execution time"
        run: |
          END_TIME=$(date +%s)
          START_TIME=${{ steps.timer.outputs.start_time }}
          DURATION=$((END_TIME - START_TIME))
          echo "â±ï¸ Total execution time: ${DURATION} seconds"
          if [ $DURATION -lt 300 ]; then
            echo "âœ… Performance test PASSED (under 5 minutes)"
          else
            echo "âš ï¸ Performance test WARNING (over 5 minutes)"
          fi

  error-handling-test:
    name: "ğŸ”§ Error Handling Test"
    runs-on: ubuntu-latest
    
    steps:
      - name: "ğŸ“¥ Checkout repository"
        uses: actions/checkout@v4

      - name: "âŒ Test with invalid image (should fail gracefully)"
        uses: ./
        continue-on-error: true
        with:
          image: 'invalid-image-name-123456'
          severity-threshold: 'HIGH'
      
      - name: "âœ… Test with empty image name (should fail gracefully)"  
        uses: ./
        continue-on-error: true
        with:
          image: ' '  # ê³µë°±ìœ¼ë¡œ ì²˜ë¦¬í•˜ì—¬ getInput required ì—ëŸ¬ ë°©ì§€
          severity-threshold: 'MEDIUM'
