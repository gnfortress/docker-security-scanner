name: ğŸ§ª Test GnFortress Docker Security Scanner

on:
  # ì½”ë“œ í‘¸ì‹œ ì‹œ ìë™ ì‹¤í–‰
  push:
    branches: [ main, develop ]
  
  # PR ìƒì„± ì‹œ ìë™ ì‹¤í–‰  
  pull_request:
    branches: [ main ]
  
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      test-image:
        description: 'Docker image to test (default: nginx:latest)'
        required: false
        default: 'nginx:latest'

jobs:
  # ğŸ§ª ê¸°ë³¸ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
  basic-test:
    name: "ğŸ” Basic Security Scan Test"
    runs-on: ubuntu-latest
    
    steps:
      - name: "ğŸ“¥ Checkout repository"
        uses: actions/checkout@v4
      
      - name: "ğŸ° Run GnFortress Docker Security Scanner"
        id: security-scan
        uses: ./  # í˜„ì¬ ë¦¬í¬ì§€í† ë¦¬ì˜ action ì‚¬ìš©
        with:
          image: 'nginx:latest'
          severity-threshold: 'MEDIUM'
          output-format: 'table'
          fail-on-critical: 'false'
      
      - name: "ğŸ“Š Display Scan Results"
        run: |
          echo "ğŸ† Scan completed successfully!"
          echo "ğŸ“ˆ Vulnerability Count: ${{ steps.security-scan.outputs.vulnerability-count }}"
          echo "ğŸ”´ Critical: ${{ steps.security-scan.outputs.critical-count }}"
          echo "ğŸŸ  High: ${{ steps.security-scan.outputs.high-count }}"
          echo "ğŸŸ¡ Medium: ${{ steps.security-scan.outputs.medium-count }}"
          echo "ğŸŸ¢ Low: ${{ steps.security-scan.outputs.low-count }}"
          echo "âœ… Status: ${{ steps.security-scan.outputs.scan-status }}"

  # ğŸš€ ë‹¤ì–‘í•œ ì´ë¯¸ì§€ í…ŒìŠ¤íŠ¸
  multi-image-test:
    name: "ğŸ”„ Multiple Images Test"
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        test-image: 
          - 'nginx:latest'
          - 'alpine:latest'
          - 'node:18'
        severity: ['HIGH', 'MEDIUM', 'LOW']
    
    steps:
      - name: "ğŸ“¥ Checkout repository"
        uses: actions/checkout@v4
      
      - name: "ğŸ” Scan ${{ matrix.test-image }} (Severity: ${{ matrix.severity }})"
        uses: ./
        with:
          image: ${{ matrix.test-image }}
          severity-threshold: ${{ matrix.severity }}
          output-format: 'json'
          
  # âš¡ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸  
  performance-test:
    name: "âš¡ Performance Test"
    runs-on: ubuntu-latest
    
    steps:
      - name: "ğŸ“¥ Checkout repository"
        uses: actions/checkout@v4
      
      - name: "â±ï¸ Measure scan time"
        run: |
          echo "ğŸ Starting performance test..."
          START_TIME=$(date +%s)
          echo "start-time=$START_TIME" >> $GITHUB_ENV
      
      - name: "ğŸš€ Quick scan test"
        uses: ./
        with:
          image: 'alpine:latest'  # ê°€ë²¼ìš´ ì´ë¯¸ì§€ë¡œ ë¹ ë¥¸ í…ŒìŠ¤íŠ¸
          severity-threshold: 'HIGH'
          cache-enabled: 'true'
      
      - name: "ğŸ“Š Calculate execution time"
        run: |
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - start_time))
          echo "â±ï¸ Total execution time: ${DURATION} seconds"
          
          if [ $DURATION -lt 300 ]; then
            echo "âœ… Performance test PASSED (under 5 minutes)"
          else
            echo "âš ï¸ Performance test WARNING (over 5 minutes)"
          fi

  # ğŸ”§ ì—ëŸ¬ í•¸ë“¤ë§ í…ŒìŠ¤íŠ¸
  error-handling-test:
    name: "ğŸ”§ Error Handling Test"
    runs-on: ubuntu-latest
    
    steps:
      - name: "ğŸ“¥ Checkout repository"
        uses: actions/checkout@v4
      
      - name: "âŒ Test with invalid image (should fail gracefully)"
        uses: ./
        continue-on-error: true  # ì—ëŸ¬ê°€ ë‚˜ë„ ì›Œí¬í”Œë¡œìš° ê³„ì† ì§„í–‰
        with:
          image: 'invalid-image-name-123456'
          severity-threshold: 'HIGH'
      
      - name: "âœ… Test with empty image name (should fail gracefully)"  
        uses: ./
        continue-on-error: true
        with:
          image: ''
          severity-threshold: 'MEDIUM'