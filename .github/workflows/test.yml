name: ğŸ§ª Test GnFortress Scanner

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  test-scanner:
    runs-on: ubuntu-latest
    name: Test Docker Security Scanner
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ° Test Security Scan - Clean Image
        id: clean-scan
        uses: ./  # í˜„ì¬ ì €ì¥ì†Œì˜ ì•¡ì…˜ ì‚¬ìš©
        with:
          image: 'hello-world:latest'
          slack-webhook: ${{ secrets.SLACK_WEBHOOK }}  # ì„ íƒì‚¬í•­
          
      - name: ğŸ“Š Show Clean Results
        run: |
          echo "Clean Image Scan Results:"
          echo "Status: ${{ steps.clean-scan.outputs.scan-status }}"
          echo "Vulnerabilities: ${{ steps.clean-scan.outputs.vulnerability-count }}"
          echo "Critical: ${{ steps.clean-scan.outputs.critical-count }}"
          
      - name: ğŸ° Test Security Scan - Vulnerable Image  
        id: vuln-scan
        uses: ./
        with:
          image: 'nginx:1.14'  # ì˜¤ë˜ëœ ë²„ì „ (ì·¨ì•½ì  ìˆì„ ê°€ëŠ¥ì„±)
          severity-threshold: 'MEDIUM'
          fail-on-critical: 'false'  # í…ŒìŠ¤íŠ¸ì´ë¯€ë¡œ ì‹¤íŒ¨í•˜ì§€ ì•ŠìŒ
        continue-on-error: true  # ì·¨ì•½ì ì´ ìˆì–´ë„ ì›Œí¬í”Œë¡œìš° ê³„ì† ì§„í–‰
          
      - name: ğŸ“Š Show Vulnerable Results
        run: |
          echo "Vulnerable Image Scan Results:"
          echo "Status: ${{ steps.vuln-scan.outputs.scan-status }}"
          echo "Vulnerabilities: ${{ steps.vuln-scan.outputs.vulnerability-count }}"
          echo "Critical: ${{ steps.vuln-scan.outputs.critical-count }}"
          echo "High: ${{ steps.vuln-scan.outputs.high-count }}"
          
      - name: ğŸ“„ Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            trivy-results.json
            trivy-results.table
        if: always()