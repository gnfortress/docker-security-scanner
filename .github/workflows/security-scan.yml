name: ğŸ›¡ï¸ Docker Security Scan

on:
  # ëª¨ë“  pushì™€ PRì—ì„œ ì‹¤í–‰
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  
  # ë§¤ì¼ ë°¤ 12ì‹œì— ìë™ ìŠ¤ìº” (ì„ íƒì‚¬í•­)
  schedule:
    - cron: '0 0 * * *'
  
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      custom-image:
        description: 'Custom Docker image to scan'
        required: false
        default: 'nginx:latest'

jobs:
  security-scan:
    name: ğŸ” Security Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      # ì—¬ëŸ¬ë¶„ì˜ Action ì‚¬ìš©!
      - name: ğŸ° Run GnFortress Security Scanner
        id: security-scan
        uses: gnfortress/docker-security-scanner@v1
        with:
          image: ${{ github.event.inputs.custom-image || 'nginx:latest' }}
          severity-threshold: 'HIGH'
          fail-on-critical: 'true'
          slack-webhook: ${{ secrets.SLACK_WEBHOOK }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          output-format: 'sarif'
      
      # ìŠ¤ìº” ê²°ê³¼ í™œìš©
      - name: ğŸ“Š Display Results
        run: |
          echo "ğŸ† Scan Status: ${{ steps.security-scan.outputs.scan-status }}"
          echo "ğŸ“ˆ Total Vulnerabilities: ${{ steps.security-scan.outputs.vulnerability-count }}"
          echo "ğŸ”´ Critical: ${{ steps.security-scan.outputs.critical-count }}"
          echo "ğŸŸ  High: ${{ steps.security-scan.outputs.high-count }}"
          
          if [ "${{ steps.security-scan.outputs.critical-count }}" -gt "0" ]; then
            echo "âš ï¸ CRITICAL VULNERABILITIES DETECTED!"
          fi
      
      # SARIF ê²°ê³¼ë¥¼ GitHub Security íƒ­ì— ì—…ë¡œë“œ
      - name: ğŸ“‹ Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: trivy-results.sarif